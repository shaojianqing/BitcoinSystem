# Introduction
Bitcoin should be seen as some kind of remarkable innovation for modern centralized financial system in this world. Bitcoin defines and operates a new kind of decentralized network which could define and deliver value in the form of bitcoin currency. 
Compared with modern centralized financial world, Bitcoin is completely decentralized network with the features of fairness, consistence and symmetry. Modern centralized financial system mainly consists of central bank and commercial bank system, and it
is based on national or government credit which is commonly unreliable and unstable in a long period and all over the world. Actually central bank plays the most centralized role in modern financial world, and it becomes the main and deep cause of financial crisis 
and unfair financial privilege, because central bank always conducts the monetary policy based on or at least influenced by some small parts of political groups, rather than most of our ordinary people. 

On the contrast, Bitcoin creates a completely new financial infrastructure for value definition and delivery, and this kind of financial infrastructure is internally based on the mathematics principle including hash digest mechanism, ECC cryptography and distributed consensus rule. Therefor Bitcoin 
network provides some kind of fair, consistent, symmetrical and stable financial infrastructure which could be seen as the revolutionary change and impact for modern centralized financial system.

Based on the above analysis and understanding of modern economics and financial principle, and the remarkable meaning of Bitcoin innovation, I finally made the decision that I could develop Bitcoin system and implement Bitcoin protocol entirely all by myself. 
Meanwhile, Java language is the most widely used computer language, so I develop Bitcoin system mainly with Java language. As the reference implementation of Bitcoin system, Bitcoin Core organizes and stores all the block and transaction data in the 
unit of block files. But in my implementation, all the blocks, transactions and UTXO accounts are organized and stored in the relational database. Here it is actually MySql database and InnoDB storage engine. As for my own purpose, my implementation is named as
BitcoinSystem, and it is regarded as my respect to Bitcoin and Satoshi. So BitcoinSystem is designed to run as a full node and could download all the blocks and transactions data from the entire worldwide Bitcoin network. The following parts describe all 
the detailed and precise system design and technical mechanism.

# General Architecture
BitcoinSystem is relatively complex system written in Java language. As a full node running in the Bitcoin P2P network, BitcoinSystem is intended to implement all aspects of Bitcoin protocol including wallet, miner and so on. Currently, the architecture of BitcoinSystem is analysed and designed 
as the diagram below. BitcoinSystem runs as a Java GUI application which provides http service as well. And it plays the role of P2P node in the Bitcoin network and communicates with other Bitcoin nodes with binary messages defined in Bitcoin protocol precisely. The content below describes all 
the main architectural components involved and combined in BitcoinSystem application.

![](https://github.com/shaojianqing/BitcoinSystem/blob/master/doc/images/general_architecture.png)
> General Architecture Design

|Seq|Module|Description|
|:-- |:--------------- |:-------------------------------------------|
|1|Context Core |This is the IOC container core just like Spring IOC, and it provides and supports annotation based context container ability. Since BitcoinSystem is intended to be developed from scratch, I implement this context core as the IOC container core, rather than using Spring IOC.|
|2|ORM Facility |This is the object relation mapping framework for domain and database operation. Because all kinds of blockchain data in BitcoinSystem are stored and managed in relational database, that kind of ORM framework is necessary to simplify the data persistence operation. For the same reason as context core, I implement this kind of ORM Facility just like ibatis.|
|3|P2P Network |This is the P2P network implementation, it includes network connection manager, peer manager, Bitcoin message packet abstraction and so on. P2P network is mainly to maintain peer status, reconnect other more peers in case of network disconnection and supports low-level message communication for Bitcoin protocol messages sync. Bitcoin works as P2P network mainly based on this component. |
|4|Messages |This is the Bitcoin message protocol implementation. It includes all the P2P messages delivered and broadcast in Bitcoin network, and defines the message data structure, implements all message processor logic. There are currently 23 kinds of Bitcoin message which contain peer status management messages, block and transaction sync messages, memory pool messages and so on. |
|5|Script Runtime |This is the script runtime mainly for transaction verification with pub key script in transaction output record and signature script in transaction input record. For flexibility consideration, it is necessary to design some kind of script mechanism so that a variety of verification could be supported easily. Bitcoin script runtime is stack-based byte code execution environment but without tour-complete feature supported. This is mainly because of network security and DDOS attack consideration. It mainly consists of byte code instruction table, instruction definition, operand stack and other assistance tools. Bitcoin script runtime is commonly initialized with public key script bytes and signature script bytes, and executed on the same operand stack. Finally, the execution result is pushed into the operand stack or throw script exception, thus verification result could be found from execution result or script exception.|
|6|Services |This is the business and data services for block and transaction process logic. They might cover block header/body persistence, block data query, transaction persistence, transaction verification status management, transaction data query and so on. As for the support for wallet, they include transaction sending logic, transaction signature generation, transaction status query and so on. Currently, we have block and transaction service for persistence and update operation, block and transaction query service for query operation, and transaction send service for wallet usage. |
|7|Wallet Core |This is the wallet business core for Bitcoin wallet feature or function implementation. It provides wallet core abilities including transaction validation, signature generation, transaction sending, balance calculation and so on. Both API server and GUI interface relies on wallet core to support transaction operation by end users.|
|8|Miner |This is the mining logic implementation for POW consensus rule. Since Bitcoin takes POW as its unique Bitcoin cash issuing method, miner module is much necessary for a full node to cooperate with others in Bitcoin network. As we all know, the real hash rate has grown to a much large scale with huge optimized GPU farm. So it is not practical and efficient enough for BitcoinSystem to mine real Bitcoin currency. But as full implementation of Bitcoin protocol, miner is still a necessary component to be implemented. |
|9|Utility Tools |This is some utilities tools supporting various usage, like byte operation, hash calculation, address conversion, hex operation and so on. Many components call this part to implement some particular feature or function, so it provides very common usage.|
|10|Crypto |This is the fundamental module for BitcoinSystem. Since Bitcoin is based on hash and crypto mechanism to construct its security, consistence and symmetry, crypto module provides signature generation and verification abilities based on ECC algorithm. It includes ECC key and signature feature implementation and signature context structure for transaction signature operation and verification. |
|11|Entities |This is the entity layer for database access and operation. BitcoinSystem chooses relational database as its persistence storage facility rather than the form of block file in Bitcoin Core. So some kind of entity layer is much necessary here. Entity layer contains all the domain data objects mapping database table and the corresponding data access objects. It also contains the related configuration xml file. The detailed design is shown in the database design section below.|
|12|API Server |This is the API server component in BitcoinSystem. Just as provided in Bitcoin Core, API server provides almost the same block and transaction api interface in the form of RESTFul JSON RPC pattern. This component could be seen as the api layer based on wallet core, including block and transaction query interface, transaction signature and sending interface.|
|13|GUI Interface |This is the GUI Interface presented for end user. It is developed based on Java Swing GUI framework and deeply customized for my own feeling. GUI interface also relies on blockchain and wallet core components and provides block list and query function, transaction search function, transaction signature and sending function. In addition, because BitcoinSystem needs to maintain peer status, GUI interface also provides peer status management function. |

# Database Entity Design

![](https://github.com/shaojianqing/BitcoinSystem/blob/master/doc/images/database_design.png)
> Database Structure Design

|Seq|Module|Description|
|:-- |:--------------- |:-------------------------------------------|
|1|block |This table is to store block header data, including block hash, previous block hash, merkel root, timestamp and so on. In order to maintain block sync and verification status, it contains sync status, verify status and transaction count as well. |
|2|transaction |This table is to store transaction data, mainly including transaction hash, corresponding block hash, lock time and verify status. The detailed transaction data including transaction input and transaction output data is stored in separate tables. |
|3|transaction_block |This table is to store the block and transaction mapping relation data. Because transaction data is designed to stored in sharding tables which is sharded by transaction hash. For fast transaction data query by block hash, this kind of mapping relation data should be stored and sharded by block hash correctly. |
|4|transaction_spend |This table is to store Bitcoin asset spending status. Because Bitcoin asset is designed to take the UTXO model, Bitcoin asset balance is calculated and presented by the coin value field in unspent transaction output, it is more convenient to store the spending status for specified transaction output record, if the total balance is calculated for a specified Bitcoin address. |
|5|transaction_input |This table is to store transaction input data originally inside transaction data. Usually, transaction input data is to declare the ownership and unlock the referenced Bitcoin asset presented by the corresponding transaction output. The main fields are from transaction hash, transaction output index and signature script. |
|6|transaction_output |This table is to store transaction output data originally inside transaction data. Because of the UTXO model, transaction output records the balance of Bitcoin asset for specified address stored in public key script. The main fields are transaction output index, coin value and public key script. |
|7|transaction_address |This table is to store transaction balance for specified address. Because of the UTXO model, the total balance of Bitcoin asset for specified address is accumulated by all unspent transaction output records. So this table here is mainly for performance consideration when calculating total Bitcoin asset. |

# Block and Transaction Structure
![](https://github.com/shaojianqing/BitcoinSystem/blob/master/doc/images/blockchain_structure.png)
> Blockchain Data Structure

### Main Data Structure in Bitcoin Blockchain 
In Bitcoin blockchain, the most important data structures are block and transaction. Different from account based model, Bitcoin takes UTXO as its main asset record style. Transaction records Bitcoin asset issuing and transfer status with transaction input and transaction output structures. Transaction input data commonly means the spending status of the Bitcoin asset from the specified transaction output, 
except for the coinbase transaction which is designed to issue new Bitcoin asset based on POW mechanism. Meanwhile, transaction output data records the Bitcoin asset issuing or transfer destination that is presented as the form of Bitcoin address. In addition, because of the size limitation of Bitcoin message, some kind of segregated witness mechanism has been introduced to reduce the size of signature script.
Hence, another kind of data structure called witness is introduced inside transaction input data body to deliver that witness and verification data for the specified transaction input/output link relation. Finally, the transaction hash is calculated with all the data parts from transaction itself, including transaction header, transaction input/output records, transaction witness body.

As for block data structure, it consists of a batch of transaction records, and all the transaction record hash keys are organized in the form of merkel tree. The root key of the merkel tree is stored in block header as the field called merkel root. And then, another field called nonce in the block header would be guessed randomly to meet the requirement of the POW mechanism. Once the specified requirement is met
successfully, the specified block and all its transactions inside the same block would be submitted to Bitcoin network. This means the block header and body would be broadcast to other more Bitcoin nodes as fast as possible. And other Bitcoin nodes receive and verify the block data, as well as all the transaction data contained in the block body. Once verified, the block would be accepted and chained into the main
blockchain. At the same time, new Bitcoin asset is issued to the coinbase address in the specified coinbase transaction still inside the accepted block. The process is well known as Bitcoin mining process in blockchain context, and this is only route to issue Bitcoin asset. Based on the above analysis of the main data structure in Bitcoin system, it could be ensured that Bitcoin system has the features of consistence,
symmetry, stability and completeness. All these features make Bitcoin network the best platform or infrastructure for value definition and delivery.

### UTXO Transaction and Asset Model Description
Bitcoin takes the UTXO model as its transaction and asset model. The full name of UTXO is unspent transaction output, it means the Bitcoin asset is defined and recorded by unspent transaction output data structure. Unlike account based model, there is no concept of account at all in Bitcoin system. Actually, there only exists the concept of Bitcoin address and the asset ownership bound with Bitcoin address. Just like 
physical cash owned by one person, Bitcoin asset is some kind of digital cash owned by some particular address, and the particular address is controlled by some person with ECC private key which is based on the ECC cryptography. As for unspent transaction output data, it should be distinguished from spent transaction output. In Bitcoin system, transaction input record links to some specified transaction output record.
If only the transaction input record is verified successfully and the block containing the corresponding transaction is accepted by Bitcoin network, the Bitcoin asset recorded in the linked transaction output record is seen as the spent status, and the ownership of the Bitcoin asset has been transferred from the original transaction output record to another transaction output record related to the spending transaction
input record. And the owner address is precisely defined in the public key script inside transaction output record. Based on the above understanding, if there is no any transaction input record links to some transaction output record, that transaction output record is seen as unspent status, and it means the ownership has not been transferred at all. As a result, the total amount of Bitcoin asset for a specified owner 
address is accumulated with all the coin values stored inside all the unspent transaction output records which are owned by the same specified owner address. This is the real and internal principle of UTXO transaction and asset model.


### Bitcoin Asset Ownership and Address
Since Bitcoin has taken the UTXO model as its transaction and asset model, another question is suggested. That is how the ownership is recognized and confirmed precisely. Let's talk about this question in detail. The ownership and security mechanism in Bitcoin system is implemented based on the ECC cryptography which is actually some kind of asymmetrical cryptography. So the ECC cryptography maintains both private key
and public key. Public key could be calculated from private key, but private key could be not calculated from public key according to the limitation of the ECC algorithm complexity. Based on this asymmetry feature in cryptography, the public key or its hash value could play the role of the Bitcoin asset address which is treated as the carrier for the Bitcoin asset ownership. On the other hand, since the ECC cryptography 
could be designed to implement the signature verification mechanism, the ECC private key could be used to generate the signature with some parts of transaction data, and the public key could be used to verify the signature with the same parts of the same transaction data. If the signature verification process is correct and successful, the ownership of the Bitcoin asset could be confirmed and ensured by the owner of the 
corresponding private key. In practice, the ECC public key or public key hash is commonly stored in the public key script content in transaction output part, and the signature from the ECC private key is stored in the signature script content inside transaction input part. This is the internal structure and relationship for the ECC private key, public key, address and the Bitcoin asset ownership.

Finally, the general data structure and relationship in Bitcoin system is conceptually illustrated in the above diagram.